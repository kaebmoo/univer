# Profit and Loss Report Generator

à¸£à¸°à¸šà¸šà¸ªà¸£à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™ P&L (Profit & Loss) à¹à¸šà¸š Excel à¸ˆà¸²à¸à¹„à¸Ÿà¸¥à¹Œ CSV à¹‚à¸”à¸¢à¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸—à¸±à¹‰à¸‡à¹à¸šà¸š Command Line à¹à¸¥à¸° Web Application

## à¸„à¸¸à¸“à¸ªà¸¡à¸šà¸±à¸•à¸´

### ğŸ“Š Core Features
- à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™ P&L Excel à¸—à¸µà¹ˆà¸¡à¸µà¸à¸²à¸£à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¸„à¸£à¸šà¸–à¹‰à¸§à¸™à¸•à¸²à¸¡à¸‚à¹‰à¸­à¸à¸³à¸«à¸™à¸”
- à¸£à¸­à¸‡à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ CSV à¸—à¸µà¹ˆ encode à¹€à¸›à¹‡à¸™ Thai (TIS-620, Windows-874)
- à¸£à¸­à¸‡à¸£à¸±à¸šà¸£à¸²à¸¢à¸‡à¸²à¸™à¸—à¸±à¹‰à¸‡ 2 à¸¡à¸´à¸•à¸´:
  - à¸¡à¸´à¸•à¸´à¸›à¸£à¸°à¹€à¸ à¸—à¸•à¹‰à¸™à¸—à¸¸à¸™ (COSTTYPE)
  - à¸¡à¸´à¸•à¸´à¸«à¸¡à¸§à¸”à¸šà¸±à¸à¸Šà¸µ (GLGROUP)
- à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™ (MTH) à¹à¸¥à¸°à¸ªà¸°à¸ªà¸¡ (YTD)

### ğŸ¨ Excel Formatting
- Font: TH Sarabun New (18pt)
- à¸ªà¸µà¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡à¸•à¸²à¸¡à¸à¸¥à¸¸à¹ˆà¸¡à¸˜à¸¸à¸£à¸à¸´à¸ˆ (8 à¸à¸¥à¸¸à¹ˆà¸¡)
- à¸ªà¸µà¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸•à¹ˆà¸¥à¸° section
- à¸£à¸¹à¸›à¹à¸šà¸šà¸•à¸±à¸§à¹€à¸¥à¸‚:
  - à¸šà¸§à¸: `1,234.00`
  - à¸¥à¸š: `(1,234.00)` à¸ªà¸µà¹à¸”à¸‡
  - à¸¨à¸¹à¸™à¸¢à¹Œ: à¸„à¹ˆà¸²à¸§à¹ˆà¸²à¸‡
- à¸•à¸µà¹€à¸ªà¹‰à¸™à¸•à¸²à¸£à¸²à¸‡
- Freeze panes

### ğŸ“ˆ Financial Calculations
- à¸à¸³à¹„à¸£à¸‚à¸±à¹‰à¸™à¸•à¹‰à¸™ (Gross Profit)
- EBITDA
- à¸à¸³à¹„à¸£à¸à¹ˆà¸­à¸™à¸«à¸±à¸à¸ à¸²à¸©à¸µ (EBT)
- à¸à¸³à¹„à¸£à¸ªà¸¸à¸—à¸˜à¸´ (Net Profit)
- à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸•à¹‰à¸™à¸—à¸¸à¸™à¸šà¸£à¸´à¸à¸²à¸£à¸•à¹ˆà¸­à¸£à¸²à¸¢à¹„à¸”à¹‰
- à¸ˆà¸±à¸”à¸à¸²à¸£ division by zero

### ğŸŒ Web Application
- Authentication à¸”à¹‰à¸§à¸¢ Email + OTP
- Login à¹„à¸”à¹‰à¹€à¸‰à¸à¸²à¸° email à¸•à¸²à¸¡ domain à¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”
- OTP 6 à¸«à¸¥à¸±à¸ (à¸­à¸²à¸¢à¸¸ 5 à¸™à¸²à¸—à¸µ)
- Development mode: à¹à¸ªà¸”à¸‡ OTP à¸šà¸™à¸«à¸™à¹‰à¸²à¸ˆà¸­
- Production mode: à¸ªà¹ˆà¸‡ OTP à¸—à¸²à¸‡ email
- JWT token à¸ªà¸³à¸«à¸£à¸±à¸š session management

### ğŸ“§ Email Features
- à¸ªà¹ˆà¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™à¸—à¸²à¸‡ email (SMTP SSL)
- à¸£à¸°à¸šà¸¸à¸œà¸¹à¹‰à¸£à¸±à¸šà¹„à¸”à¹‰à¸«à¸¥à¸²à¸¢à¸„à¸™
- à¹à¸à¹‰à¹„à¸‚ subject à¹à¸¥à¸° body à¹„à¸”à¹‰
- à¹à¸™à¸šà¹„à¸Ÿà¸¥à¹Œà¸£à¸²à¸¢à¸‡à¸²à¸™

### ğŸ’» Command Line Interface
- à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™à¸œà¹ˆà¸²à¸™ command line
- Auto-detect report type
- à¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¸£à¸°à¸šà¸¸à¸§à¸±à¸™à¸—à¸µà¹ˆ

## à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œ

```
report_generator/
â”œâ”€â”€ config/                 # Configuration files
â”‚   â”œâ”€â”€ settings.py        # Settings à¹à¸¥à¸° configuration
â”‚   â”œâ”€â”€ row_order.py       # COSTTYPE row structure
â”‚   â”œâ”€â”€ row_order_glgroup.py  # GLGROUP row structure
â”‚   â”œâ”€â”€ data_mapping.py    # COSTTYPE data mapping
â”‚   â””â”€â”€ data_mapping_glgroup.py  # GLGROUP data mapping
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ data_loader/       # Data loading modules
â”‚   â”‚   â”œâ”€â”€ csv_loader.py  # CSV file loader (Thai encoding)
â”‚   â”‚   â”œâ”€â”€ data_processor.py  # Data processing
â”‚   â”‚   â””â”€â”€ data_aggregator.py # Data aggregation
â”‚   â”œâ”€â”€ report_generator/  # Modular report generation (NEW!)
â”‚   â”‚   â”œâ”€â”€ core/          # Core components
â”‚   â”‚   â”‚   â”œâ”€â”€ config.py  # Report configuration
â”‚   â”‚   â”‚   â””â”€â”€ report_builder.py  # Main orchestrator
â”‚   â”‚   â”œâ”€â”€ columns/       # Column builders (Strategy pattern)
â”‚   â”‚   â”‚   â”œâ”€â”€ bu_only_builder.py
â”‚   â”‚   â”‚   â”œâ”€â”€ bu_sg_builder.py
â”‚   â”‚   â”‚   â””â”€â”€ bu_sg_product_builder.py
â”‚   â”‚   â”œâ”€â”€ rows/          # Row builders
â”‚   â”‚   â”œâ”€â”€ writers/       # Excel writers
â”‚   â”‚   â”‚   â”œâ”€â”€ header_writer.py
â”‚   â”‚   â”‚   â”œâ”€â”€ column_header_writer.py
â”‚   â”‚   â”‚   â”œâ”€â”€ data_writer.py
â”‚   â”‚   â”‚   â””â”€â”€ remark_writer.py
â”‚   â”‚   â”œâ”€â”€ formatters/    # Cell formatting
â”‚   â”‚   â””â”€â”€ calculators/   # Calculations
â”‚   â”œâ”€â”€ cli/               # Command-line interface
â”‚   â”‚   â””â”€â”€ cli.py
â”‚   â””â”€â”€ web/               # Web application
â”‚       â”œâ”€â”€ main.py        # FastAPI app
â”‚       â”œâ”€â”€ routes/        # API routes
â”‚       â”œâ”€â”€ models/        # Pydantic models
â”‚       â””â”€â”€ utils/         # Utilities (OTP, Email, JWT)
â”œâ”€â”€ tests/                 # All test files (NEW location!)
â”‚   â”œâ”€â”€ test_*.py          # Test suites
â”‚   â”œâ”€â”€ check_*.py         # Data validation scripts
â”‚   â””â”€â”€ run_all_tests.py   # Master test runner
â”œâ”€â”€ docs/                  # Documentation (NEW location!)
â”‚   â”œâ”€â”€ USAGE.md           # Usage guide
â”‚   â”œâ”€â”€ TESTING_GUIDE.md   # Testing procedures
â”‚   â”œâ”€â”€ REFACTOR_PLAN.md   # Refactoring documentation
â”‚   â””â”€â”€ *.md               # Other documentation files
â”œâ”€â”€ data/                  # Data files (CSV)
â”œâ”€â”€ output/                # Generated reports
â”œâ”€â”€ archive/               # Archived old implementations
â”œâ”€â”€ generate_report.py     # â­ Simple CLI entry point (RECOMMENDED!)
â”œâ”€â”€ main.py                # Main entry point (CLI or Web mode)
â”œâ”€â”€ main_generator.py      # Standalone generator (legacy)
â”œâ”€â”€ requirements.txt       # Python dependencies
â”œâ”€â”€ .env.example          # Environment variables template
â””â”€â”€ README.md             # This file
```

## Installation

### 1. Clone repository
```bash
cd /Users/seal/Documents/GitHub/univer/report_generator
```

### 2. Create virtual environment
```bash
python -m venv venv
source venv/bin/activate  # On Windows: venv\\Scripts\\activate
```

### 3. Install dependencies
```bash
pip install -r requirements.txt
```

### 4. Configure environment
```bash
cp .env.example .env
# Edit .env and configure your settings
```

## Usage

### â­ Simple CLI (à¹à¸™à¸°à¸™à¸³ - Recommended!)

à¹‚à¸›à¸£à¹à¸à¸£à¸¡ `generate_report.py` à¹€à¸›à¹‡à¸™à¸§à¸´à¸˜à¸µà¸—à¸µà¹ˆà¸‡à¹ˆà¸²à¸¢à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™ Excel

#### Quick start (à¹ƒà¸Šà¹‰à¸„à¹ˆà¸² default)
```bash
python generate_report.py
```

#### à¸£à¸°à¸šà¸¸à¸›à¸£à¸°à¹€à¸ à¸—à¸£à¸²à¸¢à¸‡à¸²à¸™à¹à¸¥à¸°à¸£à¸°à¸¢à¸°à¹€à¸§à¸¥à¸²
```bash
# COSTTYPE à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™
python generate_report.py --report-type COSTTYPE --period MTH

# GLGROUP à¸ªà¸°à¸ªà¸¡
python generate_report.py --report-type GLGROUP --period YTD
```

#### à¸£à¸°à¸šà¸¸à¸£à¸°à¸”à¸±à¸šà¸„à¸§à¸²à¸¡à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”
```bash
# à¹à¸ªà¸”à¸‡à¹€à¸‰à¸à¸²à¸° BU Total
python generate_report.py --detail-level BU_ONLY

# à¹à¸ªà¸”à¸‡ BU + Service Group Total
python generate_report.py --detail-level BU_SG

# à¹à¸ªà¸”à¸‡à¸„à¸£à¸šà¸—à¸¸à¸à¸£à¸°à¸”à¸±à¸š (BU + SG + Products) - à¸„à¹ˆà¸² default
python generate_report.py --detail-level BU_SG_PRODUCT
```

#### à¸£à¸°à¸šà¸¸à¹„à¸Ÿà¸¥à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸­à¸‡
```bash
python generate_report.py --csv-file data/TRN_PL_COSTTYPE_NT_MTH_TABLE_20251031.csv
```

#### Full options
```bash
python generate_report.py \\
    --csv-file data/TRN_PL_COSTTYPE_NT_MTH_TABLE_20251031.csv \\
    --output output/my_report.xlsx \\
    --report-type COSTTYPE \\
    --period MTH \\
    --detail-level BU_SG_PRODUCT \\
    --verbose
```

#### à¸”à¸¹à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
```bash
python generate_report.py --help
```

### Advanced CLI (à¹à¸šà¸šà¹€à¸”à¸´à¸¡)

#### Basic usage (auto-detect)
```bash
python -m src.cli.cli --data-dir ../data --output-dir ./output
```

#### Generate specific report type
```bash
python -m src.cli.cli --data-dir ../data --output-dir ./output --type COSTTYPE
```

#### Generate for specific date
```bash
python -m src.cli.cli --data-dir ../data --output-dir ./output --date 20251031
```

### Web Application

#### Start server
```bash
python -m src.web.main
# à¸«à¸£à¸·à¸­
uvicorn src.web.main:app --host 0.0.0.0 --port 8000 --reload
```

#### API Endpoints

**Authentication:**
- `POST /api/auth/request-otp` - Request OTP for email
- `POST /api/auth/verify-otp` - Verify OTP and get token
- `GET /api/auth/me` - Get current user info

**Report:**
- `GET /api/report/files` - List available data files
- `POST /api/report/generate` - Generate report
- `GET /api/report/download/{filename}` - Download report
- `POST /api/report/send-email` - Send report via email

**Documentation:**
- Swagger UI: http://localhost:8000/api/docs
- ReDoc: http://localhost:8000/api/redoc

## Configuration

### Email Setup (Gmail example)

1. Enable 2-factor authentication in your Google account
2. Generate App Password: https://myaccount.google.com/apppasswords
3. Add to `.env`:
```
SMTP_USERNAME=your_email@gmail.com
SMTP_PASSWORD=your_app_password
```

### Allowed Email Domains

Edit `.env`:
```
ALLOWED_EMAIL_DOMAINS=company.com,company.co.th,example.com
```

## Data Files

à¸£à¸°à¸šà¸šà¸£à¸­à¸‡à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ CSV à¸”à¸±à¸‡à¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰:

- `TRN_PL_COSTTYPE_NT_MTH_TABLE_YYYYMMDD.csv` - à¸¡à¸´à¸•à¸´à¸›à¸£à¸°à¹€à¸ à¸—à¸•à¹‰à¸™à¸—à¸¸à¸™ à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™
- `TRN_PL_COSTTYPE_NT_YTD_TABLE_YYYYMMDD.csv` - à¸¡à¸´à¸•à¸´à¸›à¸£à¸°à¹€à¸ à¸—à¸•à¹‰à¸™à¸—à¸¸à¸™ à¸ªà¸°à¸ªà¸¡
- `TRN_PL_GLGROUP_NT_MTH_TABLE_YYYYMMDD.csv` - à¸¡à¸´à¸•à¸´à¸«à¸¡à¸§à¸”à¸šà¸±à¸à¸Šà¸µ à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™
- `TRN_PL_GLGROUP_NT_YTD_TABLE_YYYYMMDD.csv` - à¸¡à¸´à¸•à¸´à¸«à¸¡à¸§à¸”à¸šà¸±à¸à¸Šà¸µ à¸ªà¸°à¸ªà¸¡
- `remark_YYYYMMDD.txt` - à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¸›à¸£à¸°à¸à¸­à¸šà¸£à¸²à¸¢à¸‡à¸²à¸™

**Note:** à¹„à¸Ÿà¸¥à¹Œ CSV à¸•à¹‰à¸­à¸‡ encode à¹€à¸›à¹‡à¸™ TIS-620 à¸«à¸£à¸·à¸­ Windows-874

## Development

### Run tests

#### Quick test (à¹à¸™à¸°à¸™à¸³)
```bash
# Run single test
cd tests
python test_1_imports.py

# Run report generation test
python test_2_generate.py

# Run all tests
python run_all_tests.py
```

#### Using pytest
```bash
pytest tests/
```

### Test files à¸—à¸µà¹ˆà¸ªà¸³à¸„à¸±à¸
- `tests/test_1_imports.py` - à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£ import modules
- `tests/test_2_generate.py` - à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™
- `tests/test_3_compare.py` - à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸š old vs new implementation
- `tests/test_all_reports.py` - à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™à¸—à¸¸à¸à¹à¸šà¸š
- `tests/test_phase2c.py` - à¸—à¸”à¸ªà¸­à¸šà¸£à¸°à¸”à¸±à¸šà¸„à¸§à¸²à¸¡à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸•à¹ˆà¸²à¸‡à¹†
- `tests/test_glgroup.py` - à¸—à¸”à¸ªà¸­à¸šà¸£à¸²à¸¢à¸‡à¸²à¸™ GLGROUP
- `tests/test_ytd_reports.py` - à¸—à¸”à¸ªà¸­à¸šà¸£à¸²à¸¢à¸‡à¸²à¸™ YTD

### Run with auto-reload (development)
```bash
uvicorn src.web.main:app --reload
```

### Enable debug mode
Edit `.env`:
```
DEBUG=True
APP_ENV=development
```

## Documentation

à¹€à¸­à¸à¸ªà¸²à¸£à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ `docs/`:

- ğŸ“– [`docs/USAGE.md`](docs/USAGE.md) - à¸„à¸¹à¹ˆà¸¡à¸·à¸­à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹à¸šà¸šà¸¥à¸°à¹€à¸­à¸µà¸¢à¸”
- ğŸ§ª [`docs/TESTING_GUIDE.md`](docs/TESTING_GUIDE.md) - à¸„à¸¹à¹ˆà¸¡à¸·à¸­à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸š
- ğŸ—ï¸ [`docs/REFACTOR_PLAN.md`](docs/REFACTOR_PLAN.md) - à¹à¸œà¸™ refactoring
- ğŸ“‹ [`docs/IMPLEMENTATION_STATUS.md`](docs/IMPLEMENTATION_STATUS.md) - à¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¸à¸±à¸’à¸™à¸²
- ğŸ”„ [`docs/REPORT_GENERATOR_WORKFLOW.md`](docs/REPORT_GENERATOR_WORKFLOW.md) - Workflow à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™
- âœ… [`docs/CHECKLIST.md`](docs/CHECKLIST.md) - Development checklist

### à¹€à¸­à¸à¸ªà¸²à¸£ GLGROUP
- [`docs/GLGROUP_IMPLEMENTATION_GUIDE.md`](docs/GLGROUP_IMPLEMENTATION_GUIDE.md)
- [`docs/GLGROUP_IMPLEMENTATION_COMPLETE.md`](docs/GLGROUP_IMPLEMENTATION_COMPLETE.md)
- [`docs/GLGROUP_TODO.md`](docs/GLGROUP_TODO.md)

### à¹€à¸­à¸à¸ªà¸²à¸£ Phase Development
- [`docs/PHASE1_PROGRESS.md`](docs/PHASE1_PROGRESS.md)
- [`docs/PHASE2A_COMPLETE.md`](docs/PHASE2A_COMPLETE.md)
- [`docs/PHASE2B_COMPLETE.md`](docs/PHASE2B_COMPLETE.md)
- [`docs/PHASE2C_TODO.md`](docs/PHASE2C_TODO.md)

## Troubleshooting

### CSV Encoding Issues
à¸–à¹‰à¸²à¸­à¹ˆà¸²à¸™à¹„à¸Ÿà¸¥à¹Œ CSV à¹„à¸¡à¹ˆà¹„à¸”à¹‰ à¹ƒà¸«à¹‰à¸¥à¸­à¸‡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ encoding:
```bash
python -m src.cli.cli --data-dir ../data --output-dir ./output --encoding windows-874
```

### Email Not Sending
1. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š SMTP credentials à¹ƒà¸™ `.env`
2. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² App Password à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ (à¸ªà¸³à¸«à¸£à¸±à¸š Gmail)
3. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š firewall/network settings

### OTP Not Received
- Development mode: OTP à¸ˆà¸°à¹à¸ªà¸”à¸‡à¹ƒà¸™ API response
- Production mode: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š spam folder

## License

MIT License

## Support

For issues and questions, please contact the development team.

---

**Version:** 2.0.0
**Last Updated:** 2025-11-28

## Changelog

### Version 2.0.0 (2025-11-28)
- ğŸ—‚ï¸ Reorganized project structure
  - Moved all test files to `tests/` directory
  - Moved all documentation to `docs/` directory
- â­ Added `generate_report.py` - Simple CLI entry point (recommended)
- ğŸ“Š Support for 3 detail levels: BU_ONLY, BU_SG, BU_SG_PRODUCT
- ğŸ—ï¸ Modular architecture with Strategy pattern
- ğŸ“– Updated documentation structure
