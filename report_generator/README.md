# Profit and Loss Report Generator

‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô P&L (Profit & Loss) ‡πÅ‡∏ö‡∏ö Excel ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡πÇ‡∏î‡∏¢‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö Command Line ‡πÅ‡∏•‡∏∞ Web Application

## ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥

### üìä Core Features
- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô P&L Excel ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î
- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ó‡∏µ‡πà encode ‡πÄ‡∏õ‡πá‡∏ô Thai (TIS-620, Windows-874)
- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á 2 ‡∏°‡∏¥‡∏ï‡∏¥:
  - ‡∏°‡∏¥‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (COSTTYPE)
  - ‡∏°‡∏¥‡∏ï‡∏¥‡∏´‡∏°‡∏ß‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (GLGROUP)
- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (MTH) ‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏™‡∏° (YTD)

### üé® Excel Formatting
- Font: TH Sarabun New (18pt)
- ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à (8 ‡∏Å‡∏•‡∏∏‡πà‡∏°)
- ‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ section
- ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç:
  - ‡∏ö‡∏ß‡∏Å: `1,234.00`
  - ‡∏•‡∏ö: `(1,234.00)` ‡∏™‡∏µ‡πÅ‡∏î‡∏á
  - ‡∏®‡∏π‡∏ô‡∏¢‡πå: ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
- ‡∏ï‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
- Freeze panes

### üìà Financial Calculations
- ‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô (Gross Profit)
- EBITDA
- ‡∏Å‡∏≥‡πÑ‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ (EBT)
- ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Profit)
- ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ division by zero

### üåê Web Application
- Authentication ‡∏î‡πâ‡∏ß‡∏¢ Email + OTP
- Login ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ email ‡∏ï‡∏≤‡∏° domain ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
- OTP 6 ‡∏´‡∏•‡∏±‡∏Å (‡∏≠‡∏≤‡∏¢‡∏∏ 5 ‡∏ô‡∏≤‡∏ó‡∏µ)
- Development mode: ‡πÅ‡∏™‡∏î‡∏á OTP ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
- Production mode: ‡∏™‡πà‡∏á OTP ‡∏ó‡∏≤‡∏á email
- JWT token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö session management

### üìß Email Features
- ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏≤‡∏á email (SMTP SSL)
- ‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô
- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç subject ‡πÅ‡∏•‡∏∞ body ‡πÑ‡∏î‡πâ
- ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô

### üíª Command Line Interface
- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô command line
- Auto-detect report type
- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà

## ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå

\`\`\`
report_generator/
‚îú‚îÄ‚îÄ config/                 # Configuration files
‚îÇ   ‚îú‚îÄ‚îÄ settings.py        # Settings ‡πÅ‡∏•‡∏∞ configuration
‚îÇ   ‚îî‚îÄ‚îÄ row_order.py       # Row structure definition
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ data_loader/       # Data loading modules
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ csv_loader.py  # CSV file loader (Thai encoding)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ data_processor.py  # Data processing
‚îÇ   ‚îú‚îÄ‚îÄ excel_generator/   # Excel generation modules
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ excel_generator.py  # Main generator
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ excel_formatter.py  # Formatting
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ excel_calculator.py # Calculations
‚îÇ   ‚îú‚îÄ‚îÄ cli/               # Command-line interface
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cli.py
‚îÇ   ‚îî‚îÄ‚îÄ web/               # Web application
‚îÇ       ‚îú‚îÄ‚îÄ main.py        # FastAPI app
‚îÇ       ‚îú‚îÄ‚îÄ routes/        # API routes
‚îÇ       ‚îú‚îÄ‚îÄ models/        # Pydantic models
‚îÇ       ‚îî‚îÄ‚îÄ utils/         # Utilities (OTP, Email, JWT)
‚îú‚îÄ‚îÄ data/                  # Data files (CSV)
‚îú‚îÄ‚îÄ output/                # Generated reports
‚îú‚îÄ‚îÄ tests/                 # Unit tests
‚îú‚îÄ‚îÄ requirements.txt       # Python dependencies
‚îú‚îÄ‚îÄ .env.example          # Environment variables template
‚îú‚îÄ‚îÄ CHECKLIST.md          # Development checklist
‚îî‚îÄ‚îÄ README.md             # This file
\`\`\`

## Installation

### 1. Clone repository
\`\`\`bash
cd /Users/seal/Documents/GitHub/univer/report_generator
\`\`\`

### 2. Create virtual environment
\`\`\`bash
python -m venv venv
source venv/bin/activate  # On Windows: venv\\Scripts\\activate
\`\`\`

### 3. Install dependencies
\`\`\`bash
pip install -r requirements.txt
\`\`\`

### 4. Configure environment
\`\`\`bash
cp .env.example .env
# Edit .env and configure your settings
\`\`\`

## Usage

### Command-Line Interface

#### Basic usage (auto-detect)
\`\`\`bash
python -m src.cli.cli --data-dir ../data --output-dir ./output
\`\`\`

#### Generate specific report type
\`\`\`bash
python -m src.cli.cli --data-dir ../data --output-dir ./output --type COSTTYPE
\`\`\`

#### Generate for specific date
\`\`\`bash
python -m src.cli.cli --data-dir ../data --output-dir ./output --date 20251031
\`\`\`

#### Full options
\`\`\`bash
python -m src.cli.cli \\
    --data-dir ../data \\
    --output-dir ./output \\
    --type COSTTYPE \\
    --date 20251031 \\
    --encoding tis-620 \\
    --verbose
\`\`\`

### Web Application

#### Start server
\`\`\`bash
python -m src.web.main
# ‡∏´‡∏£‡∏∑‡∏≠
uvicorn src.web.main:app --host 0.0.0.0 --port 8000 --reload
\`\`\`

#### API Endpoints

**Authentication:**
- `POST /api/auth/request-otp` - Request OTP for email
- `POST /api/auth/verify-otp` - Verify OTP and get token
- `GET /api/auth/me` - Get current user info

**Report:**
- `GET /api/report/files` - List available data files
- `POST /api/report/generate` - Generate report
- `GET /api/report/download/{filename}` - Download report
- `POST /api/report/send-email` - Send report via email

**Documentation:**
- Swagger UI: http://localhost:8000/api/docs
- ReDoc: http://localhost:8000/api/redoc

## Configuration

### Email Setup (Gmail example)

1. Enable 2-factor authentication in your Google account
2. Generate App Password: https://myaccount.google.com/apppasswords
3. Add to `.env`:
\`\`\`
SMTP_USERNAME=your_email@gmail.com
SMTP_PASSWORD=your_app_password
\`\`\`

### Allowed Email Domains

Edit `.env`:
\`\`\`
ALLOWED_EMAIL_DOMAINS=company.com,company.co.th,example.com
\`\`\`

## Data Files

‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏î‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:

- `TRN_PL_COSTTYPE_NT_MTH_TABLE_YYYYMMDD.csv` - ‡∏°‡∏¥‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
- `TRN_PL_COSTTYPE_NT_YTD_TABLE_YYYYMMDD.csv` - ‡∏°‡∏¥‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏™‡∏∞‡∏™‡∏°
- `TRN_PL_GLGROUP_NT_MTH_TABLE_YYYYMMDD.csv` - ‡∏°‡∏¥‡∏ï‡∏¥‡∏´‡∏°‡∏ß‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
- `TRN_PL_GLGROUP_NT_YTD_TABLE_YYYYMMDD.csv` - ‡∏°‡∏¥‡∏ï‡∏¥‡∏´‡∏°‡∏ß‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏™‡∏∞‡∏™‡∏°
- `remark_YYYYMMDD.txt` - ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô

**Note:** ‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ï‡πâ‡∏≠‡∏á encode ‡πÄ‡∏õ‡πá‡∏ô TIS-620 ‡∏´‡∏£‡∏∑‡∏≠ Windows-874

## Development

### Run tests
\`\`\`bash
pytest
\`\`\`

### Run with auto-reload (development)
\`\`\`bash
uvicorn src.web.main:app --reload
\`\`\`

### Enable debug mode
Edit `.env`:
\`\`\`
DEBUG=True
APP_ENV=development
\`\`\`

## Troubleshooting

### CSV Encoding Issues
‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô encoding:
\`\`\`bash
python -m src.cli.cli --data-dir ../data --output-dir ./output --encoding windows-874
\`\`\`

### Email Not Sending
1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö SMTP credentials ‡πÉ‡∏ô `.env`
2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ App Password ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Gmail)
3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö firewall/network settings

### OTP Not Received
- Development mode: OTP ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô API response
- Production mode: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö spam folder

## License

MIT License

## Support

For issues and questions, please contact the development team.

---

**Version:** 1.0.0
**Last Updated:** 2025-11-25
